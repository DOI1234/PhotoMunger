<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>PhotoMunger - Batch processing of phots</title>

<link rel="stylesheet" href="base.css" />

</head>
<body style="margin:0 10% 0 10%">



<h1 id="photomunger"><img src="image0.png" alt="Icon" title=""> PhotoMunger</h1>



<h2 id="introduction">Introduction</h2>

<p>PhotoMunger applies batch processing to a set of photos. It is designed to automate two specific workflows: 1) reducing the size of images, but only when down-scaling will not appreciably lose detail, and 2) enhancing document “scans” made with a point-and-shoot camera in lieu of a proper scanner.</p>

<p>I wrote PhotoMunger to help me automate the two tasks mentioned above which I’ve found myself needing to do on a regular basis. I published it in case there are others who also need to do these tasks and might find the tool helpful. Because of its focused purpose there are a number of things that PhotoMunger <em>won’t</em> do, including most of the various filters found in programs like <a href="http://www.gimp.org/">GIMP</a> or <a href="http://www.adobe.com/products/photoshop.html">Photoshop</a>. There may be cause to add a feature or two to PhotoMunger, but because those other tools do their jobs very well, I don’t envision it becoming a full-featured general purpose image editor.</p>

<p>PhotoMunger is open source and is licensed under the GPL (GNU Public License). The source can be found on GitHub <a href="https://github.com/programmatom/PhotoMunger">here</a>.</p>



<h2 id="outline-of-typical-workflow">Outline of Typical Workflow</h2>

<p>PhotoMunger processes all photos in one directory. The program can be launched in two ways. First, the directory to process can be specified on the command line: <code>PhotoMunger.exe &lt;path&gt;</code>. Or, if the program is launched with no arguments, it will prompt for the directory to process. Navigate <em>into</em> the directory to process and press <em>Open</em>.</p>

<p>The program then presents a dialog with various processing options. Which options to select depends on the task at hand. See sections later in this document for information about how to use these settings.</p>

<p>After the options dialog is accepted by pressing <em>OK</em>, the main window appears and the program begins analysis of the photos. Depending on the selected options, analysis may take more or less time.</p>

<p><img src="image1.jpg" alt="Main Window" title=""></p>

<p>There are 5 primary areas in the display:</p>

<ol>
<li>A list of all items in the directory. The text of each entry is gray until it has been processed, at which point it turns black. <del>Struck through</del> text indicates that the file was not recognized as a supported image type (in general, only the <em>JPEG/EXIF</em> format is supported). Images and options can be selected by clicking on the appropriate row or using the cursor keys to navigate the active cell to a different row or column. If the active cell contains a check box, the space bar will toggle between checked and unchecked. There are also a couple of options for easy access: <br>
<ul><li><em>Shrink</em>: when checked, causes the file to be down-scaled by the specified ratio (the default is 2, which cuts both the width and height in half, resulting an an image that is approximately one-quarter the size of the original).</li>
<li><em>Delete</em>: when checked, the file will be omitted from the final generated output (after <em>Apply</em> is pressed).</li></ul></li>
<li>A primary display of the current image. This rendition may or may not show annotations depending on options enabled on the toolbar.</li>
<li>A toolbar for enabling display options and performing certain transformations on the image.</li>
<li>A side-by-side display of the portion of the image under the mouse, zoomed in to full scale. The upper frame shows the original image and the lower frame shows the image after it has been <em>shrunk</em> by the shrink ratio (default is 2) and then <em>expanded</em> to the original size by a high-quality resize algorithm. This area can be used to inspect parts of the image to determine how much quality might be lost given the proposed transformation.</li>
<li>An image status area. Some basic statistics are shown here, including the width and height of the original image, the width and height of the image after cropping and down-scaling is applied, the original file size and estimated final file size for the image, check boxes to enable specific transformations, and an area where messages may be displayed if an analysis pass for one of the automatic transformations was unable to determine how to process the image.</li>
</ol>

<p>Typically, one will inspect all of the images to determine if the automatic transformations are acceptable. If automatic detection did not work as desired, specific changes can be made to an image to improve the result.</p>

<p>After image transformations have been checked and possibly modified, the output is generated by pressing <em>Apply</em> on the toolbar. If this is the first time a directory has been processed, a backup of all files is made. The files are copied to a directory in the same location with same name, but with <code>-original</code> appended. Each image is then processed and the resulting output stored in the selected directory.</p>

<p>The program saves a <code>Settings.xml</code> file in the selected directory (or in the backup directory, if it exists) containing the transformation settings and user interface options for the photo collection so that when the program is closed and reopened the options and per-image transformations are remembered.</p>



<h2 id="workflow-1-reducing-image-size">Workflow 1: Reducing Image Size</h2>



<h3 id="motivation">Motivation</h3>

<p>Today’s cameras have a huge number of pixels (for example, my Sony DSC-HX90V has 18.2 megapixels) but are often not able to utilize all of that resolution. When conditions are right, meaning bright light, no zooming, and both subject and camera stationary and stabilized, the camera may be able to make use of all of those pixels. However, adverse conditions can reduce the quality of the image, including lower light levels, movement of subject or shaking of camera (which is exacerbated by increased zoom), as well as imperfections in lens focal registration that become more pronounced as zoom increases. The megapixels are still there, but there is no significance to the high frequencies stored in the file - they are noise. For example, it is easy to visualize how a blurry image can be shrunk significantly without loss of sharpness. With photos from an 18mpix camera weighing in at 5 to 7 megabytes each, a 2-week trip to Hawaii can easily chew up 10 gigabytes. One would like to reduce the storage used, but without destroying highly detailed images.</p>



<h3 id="procedure">Procedure</h3>

<p>To work on image size reduction for a photo collection, launch the program on the directory to be processed and accept the defaults in the options dialog by pressing <em>OK</em>. The main window will appear and the program will begin analysis of the photos.</p>

<p>By default, the program displays the result of an analysis that identifies regions of an image that contain a high degree of detail that would be lost if the image were <em>shrunk</em> (down-scaled) by a factor of 2. These areas are highlighted by a mesh of yellow boxes. The computation is tuned to detect the degree of loss that a typical person might notice, but it is approximate. For important images, move the mouse over critical areas and use the side-by-side inspection panel to see how much detail would be lost.</p>

<p><img src="image2.jpg" alt="Inspecting an image for loss of detail" title=""></p>

<p>In this example, the left panel shows the yellow mesh identifying an automatically-detected area of high detail and the right panel shows the side-by-side zoomed-in view showing the loss of fine detail should the image be shrunk.</p>



<h2 id="cropping">Cropping</h2>

<p>PhotoMunger supports lossless JPEG cropping via <a href="http://jpegclub.org/"><code>jpegtran.exe</code></a>. To crop an image, first enable the cropping tool by making sure the crop button is selected on the toolbar: <br>
<img src="image3.png" alt="Crop tool" title=""></p>

<p>Once the crop tool is selected, clicking and dragging anywhere in the image will create a crop rectangle. The portion of the image inside the rectangle will be retained and that outside will be discarded.</p>

<p><img src="image25.jpg" alt="Modifying existing crop rectangle" title=""></p>

<p>An existing crop rectangle can be modified by clicking and dragging on the pads at the corners (1) or in the middle (2) of each side of the rectangle. The crop rectangle can be moved without changing it’s size or shape by clicking and dragging on the pad in the rectangle’s center (3).</p>

<p>The crop region can be cleared by clicking the clear crop button: <br>
<img src="image4.png" alt="Clear crop region" title=""></p>



<h3 id="aspect-ratio">Aspect ratio:</h3>

<p>The aspect ratio of the crop rectangle can be constrained. By default, the aspect ratio is made to match the aspect ratio of the overall image. <br>
<img src="image5.png" alt="Constrain crop aspect ratio" title=""></p>

<p>To flip the aspect ratio relative to the overall image’s aspect ratio, select the flip button. The aspect ratio remains the same, but for <em>landscape</em>-oriented images the crop rectangle will be <em>portrait</em>-oriented, and vice versa. <br>
<img src="image6.png" alt="Flip crop aspect ratio" title=""></p>

<p>To select a specific aspect ratio (for example, for targeting a specific shape for making prints), click the preset/custom aspect ratio button to open a dialog allowing the aspect ratio to be chosen. In addition to common print/page shapes it is possible to enter a width and height for a custom aspect ratio. <br>
<img src="image7.png" alt="Custom aspect ratio" title=""></p>



<h1 id="todo-rotation-setting-shrink-in-file-list"><strong>TODO: rotation; setting shrink in file list</strong></h1>



<h2 id="workflow-2-enhancing-images-scanned-via-point-and-shoot-camera">Workflow 2: Enhancing Images “Scanned” via Point-and-Shoot Camera</h2>

<p>In lieu of a scanner, one might use a point-and-shoot camera to photograph pages of a document. It can be quick, but the quality of the images is usually well below that of scans made with a document scanner since cameras are designed for taking photographs rather than scanning printed pages and therefore make processing decisions that are inappropriate for print documents. Workflow 2 demonstrates how to correct the various problems in a photographed document.</p>

<blockquote>
  <p><strong>About Edge Detection:</strong></p>
  
  <p>The edge detector used for normalizing geometry and auto-cropping relies on differences in brightness and color between the material outside the page and the page itself. Because these photos tend to be dark it has to be fairly permissive about the brightness levels; it isn’t able to detect the page edges on some surfaces.</p>
  
  <p>You can improve recognition by photographing pages on dark, color-saturated surface, such as a wood tabletop.</p>
</blockquote>

<p>Here is our initial document (click <a href="SampleScanFullSize.JPG">here</a> for the full-sized sample file):</p>

<p><img src="SampleScanSmall.JPG" alt="Original document image" title=""></p>

<p>This tutorial will walk through enabling processing options one by one. Note that once the program is running it is not necessary to quit and restart the program to get back to the global options dialog. Instead, select the global options button on the toolbar:</p>

<p><img src="image13.png" alt="Global options" title=""></p>

<p>After changes to the dialog are accepted by pressing <em>OK</em>, the program will reanalyze the images and display the updated results.</p>



<h3 id="1-bulk-rotation">1. Bulk rotation</h3>

<p>If all images were photographed with the same incorrect orientation, it can be fixed for all images at one time by setting the desired degree of clockwise rotation in the global options dialog:</p>

<p><img src="image12.png" alt="Bulk rotation" title=""></p>

<p><img src="image14.jpg" alt="Viewer with rotated image" title=""></p>



<h3 id="2-geometry-correction">2. Geometry correction</h3>

<p>Photographed documents are often geometrically skewed because it is difficult to achieve perfect alignment with a hand-held camera. PhotoMunger will attempt to detect and correct the geometry when the following processing option is enabled in the options dialog:</p>

<p><img src="image8.png" alt="enter image description here" title=""></p>

<p>If the measurements of all pages are the same and are known, the width and height can be specified as the desired aspect ratio. Otherwise the analysis will determine an aspect ratio that is approximate.</p>

<p>The page with corrected geometry is displayed in the viewer pane:</p>

<p><img src="image9.jpg" alt="Corrected geometry" title=""></p>

<p>If the geometry is not detected correctly it can be manually adjusted by the following steps.</p>

<ul>
<li>Enter the geometry adjustment mode.</li>
</ul>

<p><img src="image10.png" alt="Geometry adjustment tool" title=""></p>

<p>The main view panel will now display the original image with edge guides.</p>

<p><img src="image11.jpg" alt="Geometry edge guides" title=""></p>

<ul>
<li><p>Adjust the edges to match the page. The corners (1) can be dragged to appropriate locations. The line position can be shifted by dragging the rectangular widget shown at (2). Finally, the angle of the line can be changed by dragging the circular widget shown at (3).</p></li>
<li><p>Exit the geometry adjustment mode by pressing the same button used to enter it. After a couple of seconds the display will be updated with the new geometry adjustment.</p></li>
</ul>



<h3 id="3-removing-borders">3. Removing borders</h3>

<p>The auto-crop function can be used to find a crop rectangle that removes the surface under the page while retaining the page itself:</p>

<p><img src="image15.png" alt="Enabling auto-crop" title=""></p>

<p>After reanalysis, a crop rectangle will appear around the page.</p>

<p><img src="image16.jpg" alt="Cropped image" title=""></p>

<p>If auto-crop generates an incorrect rectangle, it can be adjusted by entering crop mode from the toolbar and moving the edges of the rectangle.</p>



<h3 id="4-improving-contrast-and-whiteness">4. Improving contrast and whiteness</h3>

<p>Most cameras center the distribution of intensity (brightness) around 50%, which is much too dark for scanned documents. To automatically correct the brightness and contrast of all images, enable the <em>Bright Adjust</em> setting in the global options. There is also an option to remove a color bias from the page background.</p>

<p><img src="image17.png" alt="Brightness adjustment" title=""></p>

<p><img src="image18.jpg" alt="Brightness adjusted" title=""></p>



<h3 id="5-flattening-uneven-lighting">5. Flattening uneven lighting</h3>

<p>The displayed page from the previous step shows a noticable darkening towards one corner. Uneven lighting is a common problem with photographed documents. To try to correct uneven lighting, enable the <em>Unbias</em> processor.</p>

<p><img src="image19.png" alt="Enabling unbias" title=""></p>

<p><img src="image20.jpg" alt="After unbias" title=""></p>



<h3 id="6-oversaturating">6. Oversaturating</h3>

<p>In some cases, light shading can be removed by oversaturating the bright end of the image, and darkness of text can be improved by oversaturating on the dark end. To do this, enable the <em>Static Saturation</em> option. The white threshhold determines what brightness value will now become 1 (maximum brightness). The black threshhold determines what brightness value will now become 0 (minimum brightness, or black). The exponent can apply a curve to the distribution of brightness: 1 applies no curve, greater than 1 brightens midtones, less than 1 darkens midtones.</p>

<p><img src="image21.png" alt="Enabling static saturation" title=""></p>

<p><img src="image22.jpg" alt="Saturated" title=""></p>



<h3 id="7-converting-to-black-and-white">7. Converting to black and white</h3>

<p>In some cases it may be desirable to convert the image to black-and-white, stored as one bit per pixel. When stored in PNG format in this way, scanned image files are often much smaller than the equivalent JPEG file. They are also more suitable to printing on a black-and-white printer, if called for. To convert to black-and-white image, enable <em>Monochrome Bitmap Output</em>.</p>

<p><img src="image23.png" alt="Enabling monochrome bitmap output" title=""></p>

<p><img src="image24.jpg" alt="Monochrome" title=""></p>



<h3 id="8-generate">8. Generate</h3>

<p>Press <em>Apply</em> on the toolbar to generate the final output image.</p>



<h3 id="final-notes">Final notes</h3>

<p>Although this tutorial walked through each image processing step separately, usually the settings would be chosen all at once based on the specific condition of the photograph collection. If the results are unsatisfactory, it might be necessary to tweak certain threshholds or other settings. Fortunately, most images in a batch will tend to have the same defects and biases, allowing batch processing with global parameters to do a good job on all of the images.</p>

<hr>

<p>Last updated September 2016. Authored using <a href="http://www.adobe.com/products/photoshop.html">stackedit</a>.</p>



</body>
